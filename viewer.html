<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>peerjs callee</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        div {
            position: relative;
            text-align: center;
        }
        span {
            position: absolute;
            left: 50%;
            transform: translate(-50%,-50%);
            z-index: 1;
            font-size: x-large;
            font-weight: bold;
            background-color: azure;

        }
        span.label {
            top: 5%;
        }
        span.stats{
            bottom: 5%;
        }
        video {
            transform: scale(-1, 1);
            z-index: -1;
        }
    </style>
</head>
<body>
<div>
    <span id="label" class="label"></span>
    <video autoplay playsinline muted></video><br>
    <span id="stats" class="stats"></span>
    <p>Click on the video to switch between the local camera and the remote stream</p>
</div>
<script>
    let video = document.querySelector('video');
    let statsText = document.getElementById('stats');
    let labelText = document.getElementById('label');
    let localStream, remoteStream;

    window.localStream = localStream;

    const myId = '2ceef1a5-2145-43a6-8cba-235423af1412';
    let peer = new Peer( myId, {debug: 3});

    peer.on('connection', conn => conn.on('data', data => console.log(`Incoming data: ${data}`)));
    peer.on('disconnected', ()=>console.log("Peer disconnected"));

    // ToDo: fix this
    // video stats
    video.onloadedmetadata = () =>{

        let decodedFrames = 0,
            droppedFrames = 0,
            startTime = new Date().getTime(),
            initialTime = new Date().getTime();

        setInterval(()=>{

            let currentTime = new Date().getTime();
            let deltaTime = (currentTime - startTime) / 1000;
            // let totalTime = (currentTime - initialTime) / 1000;
            startTime = currentTime;

            // Calculate decoded frames per sec.
            let currentDecodedFPS  = (video.webkitDecodedFrameCount - decodedFrames) / deltaTime;
            //let decodedFPSavg = video.webkitDecodedFrameCount / totalTime;
            decodedFrames = video.webkitDecodedFrameCount;

            // Calculate dropped frames per sec.
            //let currentDroppedFPS = (video.webkitDroppedFrameCount - droppedFrames) / deltaTime;
            //let droppedFPSavg = video.webkitDroppedFrameCount / totalTime;
            droppedFrames = video.webkitDroppedFrameCount;

            statsText.innerText = `${video.videoHeight}p${currentDecodedFPS.toFixed(1)}`;
        }, 500)

    };
    peer.on('open',  id=> console.log('My peer ID is: ' + id));

    peer.on('call', call=>{
        call.on('stream', stream=>{
            remoteStream = stream;
            video.srcObject = remoteStream;
            labelText.innerText = 'Remote';
        });

        call.answer();
    });


    navigator.mediaDevices.getUserMedia({video: {
            width: {ideal: 1920},
            height: {ideal: 1080},
            facingMode: {ideal: "environment"}
        }})
        .then(stream=>localStream=stream)
        .catch(err=>console.error(err));

    // ToDo: add getUserMedia, switch to gUM video
    video.addEventListener('click', ()=>{
        if(localStream && labelText.innerText==="Remote") {
            video.srcObject = localStream;
            labelText.innerText = 'Local';
            console.log("Set local stream");
        }
        else if(remoteStream && labelText.innerText==="Local"){
            video.srcObject = remoteStream;
            labelText.innerText = 'Remote';
            console.log("Set remote stream");
        }
        else
            console.error("No stream available to switch or invalid state");
    })

</script>
</body>
</html>
