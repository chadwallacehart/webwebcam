<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select Device gUM</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
<label for="videoSource">Video input source: </label><select id="videoSource"></select>
<video autoplay playsinline muted></video>
<script>

    // Taken from https://github.com/webrtc/samples/blob/gh-pages/src/content/devices/input-output/js/main.js
    const videoSelect = document.querySelector('select#videoSource');
    const selectors = [videoSelect];
    let stream;

    function gotDevices(deviceInfos) {
        // Handles being called several times to update labels. Preserve values.
        const values = selectors.map(select => select.value);
        selectors.forEach(select => {
            while (select.firstChild) {
                select.removeChild(select.firstChild);
            }
        });
        for (let i = 0; i !== deviceInfos.length; ++i) {
            const deviceInfo = deviceInfos[i];
            const option = document.createElement('option');
            option.value = deviceInfo.deviceId;
 /*           if (deviceInfo.kind === 'audioinput') {
                option.text = deviceInfo.label || `microphone ${audioInputSelect.length + 1}`;
                audioInputSelect.appendChild(option);
            } else if (deviceInfo.kind === 'audiooutput') {
                option.text = deviceInfo.label || `speaker ${audioOutputSelect.length + 1}`;
                audioOutputSelect.appendChild(option);
            } else */
            if (deviceInfo.kind === 'videoinput') {
                option.text = deviceInfo.label || `camera ${videoSelect.length + 1}`;
                videoSelect.appendChild(option);
            } else {
                console.log('deviceInfo: ', deviceInfo);
            }
        }
        selectors.forEach((select, selectorIndex) => {
            if (Array.prototype.slice.call(select.childNodes).some(n => n.value === values[selectorIndex])) {
                select.value = values[selectorIndex];
            }
        });
    }

    function getMedia(){
        console.log("videoSelect change");
        if(stream)
            stream.getTracks().forEach(track=>track.stop);
        const videoSource = videoSelect.value;
        const constraints = {
            video:  {deviceId: videoSource ? {exact: videoSource} : undefined}
        };

        navigator.mediaDevices.getUserMedia(constraints)
            .then(stream=>document.querySelector('video').srcObject = stream)
            .catch(err=>console.error(err));
    }

    videoSelect.onchange = getMedia;
    navigator.mediaDevices.enumerateDevices().then(gotDevices).then(getMedia).catch(err=>console.error(err));

</script>
</body>
</html>
